/*! auth - v1.5 - 2013-08-11 8:15:18 PM
* Copyright (c) 2013 ��ͦ; Licensed  */
KISSY.add("gallery/auth/1.5/lib/rule/rule",function(a,b,c){function d(b,c,e){var f=this;return a.isString(b)&&a.isFunction(c)?(a.isObject(e)||(e={args:[]}),a.mix(e,{name:b,validation:c}),d.superclass.constructor.call(f,e),void 0):f}return a.extend(d,b,{validate:function(){var b=this,c=b.get("validation"),d=b._getArgs(),e=b.get("_defer"),f=c.apply(b,d);if(a.isBoolean(f)){var g=f;return f=e.promise,e[g&&"resolve"||"reject"](b),f}return f},_getArgs:function(){var a=this,b=new c.Defer,d=a.get("field"),e=[a.get("value"),a.get("propertyValue"),b,d];return a.set("_defer",b),e}},{ATTRS:{name:{value:""},value:{value:"",getter:function(a){var b=this.get("target");return b.length?b.val():a}},propertyValue:{value:"",getter:function(a){var b=this.get("target");return b.length?b.attr(this.name):a}},msg:{value:{error:"",success:""}},validation:{value:function(){}},target:{value:"",getter:function(b){return a.one(b)}},field:{value:""},_defer:{value:""}}}),d},{requires:["base","promise"]}),KISSY.add("gallery/auth/1.5/lib/rule/ruleFactory",function(a,b,c,d){b.all;var e=function(){var a=this;e.superclass.constructor.call(a)};return e.rules={},a.mix(e.rules,{required:function(b){return a.isArray(b)?b.length>0:!!b},pattern:function(a,b){return new RegExp(b).test(a)},max:function(b,c){return a.isNumber(b)?c>=b:!1},min:function(b,c){return a.isNumber(b)?b>=c:!1},step:function(b,c){return a.isNumber(b)?0==b||1==c?!0:b%c:!1},equalTo:function(b,c){return a.isNumber(b)?c===b:a.one(c)?a.one(c).val()===b:c===b}}),a.mix(e,{HTML_PROPERTY:["required","pattern","max","min","step","equalTo"],register:function(a,b){e.rules[a]=b},create:function(a,b){return new d(a,e.rules[a],b)}}),e},{requires:["node","base","./rule"]}),KISSY.add("gallery/auth/1.5/lib/msg/base",function(a,b,c,d){function e(b,c){var d=this;c||(c={}),b&&a.mix(c,{target:b}),e.superclass.constructor.call(d,c),d._init()}var f=c.all,g=".J_AuthMsg";return a.extend(e,b,{_init:function(){var a=this,b=a.get("target");if(!b.length)return!1;var c=a._getWrapper();c.hide(),a.set("wrapper",c);var d=a.get("host");d.on("error",function(b){var c=b.msg,d=b.style||"error";a.show({style:d,msg:c})}),d.on("success",function(b){var c=b.msg,d=b.style;c||d?(d=b.style||"success",a.show({style:d,msg:c})):a.hide()})},hide:function(){var b=this,c=b.get("wrapper");a.buffer(function(){c.slideUp(b.get("speed"))},50)()},show:function(b){var c=this;c.get("args");var e=c.get("tpl"),f=c.get("wrapper");a.buffer(function(){if(!f.children(".auth-msg").length||b.reCreate){var a=new d(e).render(b);f.html(a)}f.slideDown(c.get("speed"))},50)()},_getWrapper:function(){var a=this,b=a.get("wrapper"),c=a.get("target");if(!c.length)return a;var d=c.attr("msg-wrapper");if(d&&(b=f(d)),!b||!b.length){var e=f(c.parent());b=e.all(g)}return b}},{ATTRS:{host:{value:""},target:{value:"",getter:function(a){return f(a)}},tpl:{value:'<p class="auth-msg auth-{{style}}">{{msg}}</p>'},wrapper:{value:"",getter:function(a){return f(a)}},speed:{value:.3}}}),e},{requires:["base","node","xtemplate"]}),KISSY.add("gallery/auth/1.5/lib/utils",function(S,DOM,undefined){var Utils={toJSON:function(cfg){cfg=cfg.replace(/'/g,'"');try{eval("cfg="+cfg)}catch(e){S.log("data-valid json is invalid")}return cfg},guid:function(){return"AUTH_"+S.guid()},getEvent:function(a){var b="blur",c=DOM.attr(a,"type");switch(c){case"select-multiple":case"radio":case"checkbox":b="click";break;default:b="blur"}return b},getValue:function(a){var b=[],c=DOM.attr(a,"type");switch(c){case"select-multiple":S.each(a.options,function(a){a.selected&&b.push(a.value)});break;case"radio":case"checkbox":S.each(a,function(a){a.checked&&b.push(a.value)});break;default:b=DOM.val(a)}return b}};return Utils},{requires:["dom"]}),KISSY.add("gallery/auth/1.5/lib/field/field",function(a,b,c,d,e,f,g,h,i,j){function k(b){var c=g.rules,d={};return a.each(c,function(a,c){b.attr(c)&&(d[c]={error:b.attr(c+"-msg"),success:b.attr(c+"-success-msg")||"",propertyValue:b.attr(c)})}),d}function l(b){var c={};if(b=n(b),!b||!b.length)return c;var d=k(b);a.isEmptyObject(d)||(c.rules=d);var e=b.attr("auth-event");return e&&(c.event=e),c}function m(b,c){var d=this;d._validateDone={},d._cache={};var e=l(b);return c=a.merge(p,c,e),d._cfg=c,a.mix(c,{target:b}),d._storage={},m.superclass.constructor.call(d,c),d._init(),d}var n=e.all,o="",p={event:"blur",style:{success:"ok",error:"error"}};return a.mix(m,{_defer:new f.Defer}),a.extend(m,c,{_init:function(){var b=this,c=b._cfg,d=b.get("target"),e=a.merge({},c.rules);if(a.inArray(d.attr("type"),["checkbox","radio"])){var f=d.getDOMNode().form,h=d.attr("name"),k=[];a.each(document.getElementsByName(h),function(a){a.form==f&&k.push(a)}),b.set("target",k)}var l=b._cfg.msg||{};l.host=b,b._msg=new i(d,l),b.set("oMsg",b._msg),a.each(e,function(a,c){if(!b._storage[c]&&g.rules[c]){var d=b._createRule(c,a);b.add(c,d)}});var m=b.get("target").getDOMNode();b._targetBind(c.event||j.getEvent(m))},_targetBind:function(b){var c=this,d=c.get("target");return d.length?(d.on(b,function(){a.later(function(){c.validate()})}),c):!1},_createRule:function(b,c){var d=this,e=d.get("target");return a.mix(c,{value:e.val(),target:e,msg:c,field:d}),g.create(b,c)},add:function(b,c){var d=this,e=d._storage;return c instanceof h?e[b]=c:a.isFunction(c)&&(e[b]=new h(b,c,{el:d._el})),d.set("rules",e),e[b]&&e[b].on("validate",function(b){a.log("[after rule validate]: name:"+b.name+",result:"+b.result+",msg:"+b.msg),d._cache[b.name].result=b.result,d._cache[b.name].msg=b.msg}),this._cache[b]={},d},remove:function(a){var b=this._storage;return delete b[a],delete this._cache[a],self.set("rules",b),this},test:function(a){return this.validate(a)},validate:function(b){function c(a){if(l>=e.length)return j;var b=a;j=b.validate(),l++,j.then(function(){c(e[l])})}var d=this,e=[],f=d.get("rules");if(a.isString(b)){var g=b.split(",");a.each(g,function(a){f[a]&&e.push(f[a])})}else a.each(f,function(a){e.push(a)});var h=d.get("exclude");if(""!=h){var i=h.split(",");a.filter(e,function(b){return!a.inArray(b.get("name"),i)})}d.fire("beforeTest",{rules:e});var j,k=m._defer,l=0;return c(e[l]),j.then(function(a){d._fireTestEvent("success",a),k.resolve(d)}).fail(function(a){d._fireTestEvent("error",a),k.reject(d)}),k.promise},_fireTestEvent:function(a,b){var c=this;return c.fire(a,{rule:b,msg:b.get(a),name:b.get("name")})}},{ATTRS:{message:{value:o},result:{},target:{value:"",getter:function(a){return n(a)}},event:{value:"",setter:function(a){var b=this;return b._targetBind(a),a}},exclude:{value:""},rules:{value:{}},oMsg:{value:""}}}),m},{requires:["event","base","dom","node","promise","../rule/ruleFactory","../rule/rule","../msg/base","../utils"]}),KISSY.add("gallery/auth/1.5/lib/base",function(a,b,c,d,e,f,g,h){var i=b.all,j=function(b,c){var d=this;return c||(c={}),b&&a.mix(c,{target:b}),d._storages={},d.AuthConfig=c,j.superclass.constructor.call(d,c),d};return a.mix(j,{_defer:new e.Defer}),a.extend(j,d,{render:function(){var b=this,c=b.get("target"),d=c.getDOMNode().elements;if(!d.length)return b;var e=b.get("autoBind");return a.each(d,function(a){var c={event:e?h.getEvent(a):"none"},d=new f(a,c);d.addTarget(b),d.publish("validate",{bubble:1}),b.add(d)}),c.attr("novalidate","novalidate"),b},add:function(b,c){var d,e,g=this,i="";if(b instanceof f)d=b.get("target"),e=g.getName(d),i=g._storages[e||h.guid()]=b;else{if(d=a.one(b),!d.length)return!1;e=g.getName(d),i=g._storages[e]=new f(d,c)}return i},getName:function(a){return a&&a.length?a.attr("id")||a.attr("name")||h.guid():""},getField:function(a){return this._storages[a]},register:function(a,b){return g.register(a,b),this},test:function(a){return this.validate(a)},validate:function(){var b=this;b.fire("beforeValidate");var c,d=!0;a.each(b._storages,function(a){var e=a.validate();return d=d&&e,c=a,b.AuthConfig.stopOnError&&!d?!1:void 0}),b.fire("validate",{result:d,lastField:c}),b.set("result",d),b.fire("afterValidate");var e=j._defer;return e[d&&"resolve"||"reject"](d),e.promise}},{ATTRS:{target:{value:"",getter:function(a){return i(a)}},autoBind:{value:!0},stopOnError:{value:!1}}}),a.mix(j,{Field:f}),j},{requires:["node","json","base","promise","./field/field","./rule/ruleFactory","./utils"]}),KISSY.add("gallery/auth/1.5/lib/index",function(a,b){return b},{requires:["./base"]}),KISSY.add("gallery/auth/1.5/index",function(a,b){return b},{requires:["./lib/index"]});